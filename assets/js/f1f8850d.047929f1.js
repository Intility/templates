"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[2155],{3905:function(t,e,n){n.d(e,{Zo:function(){return c},kt:function(){return m}});var r=n(7294);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function u(t,e){if(null==t)return{};var n,r,a=function(t,e){if(null==t)return{};var n,r,a={},o=Object.keys(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||(a[n]=t[n]);return a}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}var l=r.createContext({}),s=function(t){var e=r.useContext(l),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},c=function(t){var e=s(t.components);return r.createElement(l.Provider,{value:e},t.children)},p="mdxType",d={inlineCode:"code",wrapper:function(t){var e=t.children;return r.createElement(r.Fragment,{},e)}},h=r.forwardRef((function(t,e){var n=t.components,a=t.mdxType,o=t.originalType,l=t.parentName,c=u(t,["components","mdxType","originalType","parentName"]),p=s(n),h=a,m=p["".concat(l,".").concat(h)]||p[h]||d[h]||o;return n?r.createElement(m,i(i({ref:e},c),{},{components:n})):r.createElement(m,i({ref:e},c))}));function m(t,e){var n=arguments,a=e&&e.mdxType;if("string"==typeof t||a){var o=n.length,i=new Array(o);i[0]=h;var u={};for(var l in e)hasOwnProperty.call(e,l)&&(u[l]=e[l]);u.originalType=t,u[p]="string"==typeof t?t:a,i[1]=u;for(var s=2;s<o;s++)i[s]=n[s];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},9497:function(t,e,n){n.r(e),n.d(e,{assets:function(){return c},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return u},metadata:function(){return s},toc:function(){return p}});var r=n(7462),a=n(3366),o=(n(7294),n(3905)),i=["components"],u={title:"Security - Authorization",sidebar_label:"Authorization",slug:"/Setup/Security/Authorization",sidebar_position:2},l=void 0,s={unversionedId:"setup/Security/Authorization",id:"setup/Security/Authorization",title:"Security - Authorization",description:"| Method | Description |",source:"@site/express/setup/Security/Authorization.mdx",sourceDirName:"setup/Security",slug:"/Setup/Security/Authorization",permalink:"/express/Setup/Security/Authorization",draft:!1,editUrl:"https://github.com/Intility/templates/tree/main/docusaurus/express/setup/Security/Authorization.mdx",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Security - Authorization",sidebar_label:"Authorization",slug:"/Setup/Security/Authorization",sidebar_position:2},sidebar:"express",previous:{title:"Sentry",permalink:"/express/Setup/Sentry"},next:{title:"CORS",permalink:"/express/Setup/Security/CORS"}},c={},p=[{value:"Authentication",id:"authentication",level:2},{value:"Authorization",id:"authorization",level:2},{value:"User values in token",id:"user-values-in-token",level:3},{value:"Roles",id:"roles",level:3},{value:"BONUS: ROT OData API query",id:"bonus-rot-odata-api-query",level:4}],d={toc:p};function h(t){var e=t.components,n=(0,a.Z)(t,i);return(0,o.kt)("wrapper",(0,r.Z)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Method"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Authentication"),(0,o.kt)("td",{parentName:"tr",align:null},"Authentication is the process of proving that you are who you say you are. It's sometimes shortened to AuthN. The Microsoft identity platform uses the OpenID Connect protocol for handling authentication.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Authorization"),(0,o.kt)("td",{parentName:"tr",align:null},"Authorization is the act of granting an authenticated party permission to do something. It specifies what data you're allowed to access and what you can do with that data. Authorization is sometimes shortened to AuthZ. The Microsoft identity platform uses the OAuth 2.0 protocol for handling authorization.")))),(0,o.kt)("p",null,"Source: ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/authentication-vs-authorization"},"Authentication vs. authorization - Microsoft identity platform")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"This assumes that you have an Azure AD application registration created for your project."),(0,o.kt)("p",{parentName:"admonition"},"This section assume that you have created an ",(0,o.kt)("a",{parentName:"p",href:"../ApplicationRegistrations"},"Azure AD application registrations"),".")),(0,o.kt)("h2",{id:"authentication"},"Authentication"),(0,o.kt)("p",null,"In some cases you only want to authenticate your user. to do this, add the ",(0,o.kt)("inlineCode",{parentName:"p"},"authenticate")," middleware to your routes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'router.get("/", authenticate, controller.getByOid);\nrouter.post("/", authenticate, controller.createNewUser);\n')),(0,o.kt)("h2",{id:"authorization"},"Authorization"),(0,o.kt)("p",null,"Authorization is mostly done by inspecting the authenticated token and conditionally allow or decline users from accessing certain endpoints. We are checking for values like:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"tid")," or tenantId: The authenticated users origin tenant ID."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"acct")," or account: Users account status in tenant."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"roles"),": List of roles for this application.")),(0,o.kt)("h3",{id:"user-values-in-token"},"User values in token"),(0,o.kt)("p",null,"It's equally important to ensure that the API only responds with data or allow actions which corresponds to the authorized user's role. An example can be that you've created a multi-tenant API with a common endpoint for fetching a company's mobile subscriptions. It's then essential to actually force that multi-tenancy in your code. To accomplish this we can take a look at some of the claims provided in the token. We use token claims because they contain information about the user which are provided by a trusted resource (AD/Azure AD). "),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"upn"),", User principal name: this is the same as primary email for Intility users and can be used to identify the user."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"tid"),", Tenant ID: this can either be used alone if you have this filed in your dataset, or with ROT-OData API to lookup the company GUID or company code. This is especially important for multi tenant applications.")),(0,o.kt)("h3",{id:"roles"},"Roles"),(0,o.kt)("p",null,"An official guide on how to configure your application registration to use app roles and receiving them in the token can be found in this guide: ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps"},"How to: Add app roles to your application and receive them in the token")),(0,o.kt)("p",null,"Validating and checking the token is done by creating an Express middleware that validating the claims provided by the token. Passport saves the decoded token fields in the request object."),(0,o.kt)("p",null,"To implement authorization on your endpoints, add the ",(0,o.kt)("inlineCode",{parentName:"p"},"authorize")," middleware to your routes and provide a set of roles as the parameter"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"router.get(\"/\", authenticate, authorize(['Api.Read']), controller.getByOid);\nrouter.post(\"/\", authenticate, authorize(['Api.Read', 'Api.Write']), controller.createNewUser);\n")),(0,o.kt)("h4",{id:"bonus-rot-odata-api-query"},"BONUS: ROT OData API query"),(0,o.kt)("p",null,"The following query can be used to get a Company's GUID and/or code (e.g. AA) by the ",(0,o.kt)("inlineCode",{parentName:"p"},"tid")," claim provided in the token by using the ROT OData API. You can find the Official API documentation here: ",(0,o.kt)("a",{parentName:"p",href:"https://gitlab.intility.com/DeveloperServices/open-rot-api"},"open-rot-api")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"<ROT_BASE_URL>/ROTDirectoryAzureTenant?$filter=AzureTenantGUID eq <TENANT_ID_FROM_TOKEN>&$select=Directory, AzureTenantGUID&$expand=Directory($select=Name, CompanyGUID)")))}h.isMDXComponent=!0}}]);